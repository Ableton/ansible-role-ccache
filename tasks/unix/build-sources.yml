---
- name: Check ccache version
  ansible.builtin.command: "ccache --version"
  environment:
    PATH: "{{ ccache_install_prefix }}/bin:{{ ansible_pkg_mgr_path }}"
  changed_when: false
  failed_when: false
  register: ccache_version_cmd

- name: Build ccache from sources
  when: >
    ccache_version_cmd.rc != 0 or
    ccache_version not in ccache_version_cmd.stdout_lines[0]
  block:
    - name: Fetch ccache sources
      ansible.builtin.get_url:
        url: "https://github.com/ccache/ccache/releases/download/v{{ ccache_version }}\
          /ccache-{{ ccache_version }}.tar.gz"
        dest: "{{ ccache_build_dir }}"
        mode: "0644"

    - name: Uncompress ccache tarball
      ansible.builtin.unarchive:
        src: "{{ ccache_build_dir }}/ccache-{{ ccache_version }}.tar.gz"
        dest: "{{ ccache_build_dir }}"
        mode: "0755"
        remote_src: true

    - name: Run configure script
      ansible.builtin.command: "./configure --prefix={{ ccache_install_prefix }}"
      args:
        chdir: "{{ ccache_build_dir }}/ccache-{{ ccache_version }}"
      changed_when: false

    - name: Build ccache
      ansible.builtin.command: "make -j{{ ccache_make_jobs }}"
      args:
        chdir: "{{ ccache_build_dir }}/ccache-{{ ccache_version }}"
      changed_when: false

    - name: Install ccache
      become: true
      # TODO: Remove this suppression when ansible-lint learns to parse block conditions
      # See: https://github.com/ansible/ansible-lint/issues/1894
      ansible.builtin.command: "make install"  # noqa no-changed-when
      args:
        chdir: "{{ ccache_build_dir }}/ccache-{{ ccache_version }}"

    - name: Cleanup build directory
      ansible.builtin.file:
        path: "{{ ccache_build_dir }}/ccache-{{ ccache_version }}"
        state: absent

    - name: Cleanup source tarball
      ansible.builtin.file:
        path: "{{ ccache_build_dir }}/ccache-{{ ccache_version }}.tar.gz"
        state: absent
